# 台风物理-AI对齐分析图 - 变量取值说明（简化版）

## 文档目标

说明每张台风分析图中各可视化元素的数据来源和取值逻辑。

---

## 一、数据集结构

### 原始数据时间范围
2022-01-01 00:00 → 2022-01-02 06:00（共6个时间点，每6小时一次）

### GraphCast 数据划分

```
输入历史（train_inputs）:
  ├─ 时间点0: 01/01 00:00 (-6h)
  └─ 时间点1: 01/01 06:00 (0h，参考时刻)

预测目标（train_targets）:
  ├─ 时间点0: 01/01 12:00 (+6h)
  ├─ 时间点1: 01/01 18:00 (+12h)
  ├─ 时间点2: 01/02 00:00 (+18h)
  └─ 时间点3: 01/02 06:00 (+24h)
```

### 台风位置数据（硬编码）

| 时间 | 纬度 | 经度 | 数据源 | 时间索引 |
|------|------|------|--------|---------|
| 01/01 00Z | -21.22° | 156.71° | 输入 | 0 |
| 01/01 06Z | -21.78° | 157.46° | 输入 | 1 |
| 01/01 12Z | -22.56° | 158.29° | 预测 | 0 |
| 01/01 18Z | -23.91° | 158.80° | 预测 | 1 |
| 01/02 00Z | -25.83° | 159.01° | 预测 | 2 |

---

## 二、单张图的变量取值逻辑

以**图2（2022-01-01 06Z）**为例：

```
台风位置: (-21.78°, 157.46°)
数据类型: 输入数据
时间索引: 1
```

### 1. 梯度热力图（AI的关注区域）

**作用**: 显示AI模型认为哪些区域对台风预测最重要

**数据来源**:
- 变量: `geopotential`（位势高度）
- 数据集: `train_inputs`（始终使用输入历史）
- 时间: 索引1（对应06Z的输入状态）
- 气压层: 500 hPa
- 空间: 全球网格 → 裁剪到台风周围±15°

**为什么这样选**:
- 梯度反映输入对预测的影响，所以始终来自输入数据
- 500 hPa代表中层大气，是台风强度的关键指标

---

### 2. 等压线（物理场背景）

**作用**: 显示海平面气压分布，标识台风的低压系统

**数据来源**:
- 变量: `mean_sea_level_pressure`（海平面气压）
- 数据集: `train_inputs`（因为是输入时刻）
- 时间: 索引1（对应06Z）
- 单位: hPa（已转换）

**为什么这样选**:
- 对于输入时刻（00Z, 06Z）→ 从`train_inputs`取数据
- 对于预测时刻（12Z, 18Z, 00Z+24h）→ 从`train_targets`取数据
- 海平面气压是识别台风位置的最直观物理量

---

### 3. 引导气流箭头（台风移动趋势）

**作用**: 显示环境风场推动台风移动的方向

**数据来源**:
- 变量: `u_component_of_wind`, `v_component_of_wind`
- 数据集: `train_inputs`（因为是输入时刻）
- 时间: 索引1（对应06Z）
- 气压层: **700 hPa**（单层）
- 空间平均: 环形区域（内半径2°，外半径5°）

**关键参数**:

| 参数 | 值 | 说明 |
|------|-----|------|
| 气压层 | 700 hPa | 对热带风暴最准确的引导层 |
| 内半径 | 2° | 排除台风自身环流影响 |
| 外半径 | 5° | 捕获环境引导气流 |
| 箭头方向 | 顺风 (u, v) | 指向台风移动趋势 |

**为什么这样选**:

**气压层选择（从5层改为1层）**:
- 初始方案: 850、700、500、300、200 hPa 五层平均
- 问题: 各层风向差异>50°，平均后相互抵消
- 诊断结果:
  - 850 hPa: 方向完全错误（误差>60°）
  - 700 hPa: 最准确（平均误差14.9°）
  - 500-200 hPa: 偏东，与低层冲突
- 结论: 对于弱热带风暴，只用700 hPa单层

**环形区域参数（从3-7°改为2-5°）**:
- 参数扫描30种组合的结果
- 2-5°: 平均误差29.5°（最优）
- 3-7°: 平均误差33.7°（原标准）

**箭头方向（从逆风改为顺风）**:
- 原方向: (-u, -v) = 气流来源（上游）
- 新方向: (u, v) = 台风移动趋势（下游）
- 更直观: 箭头指向台风下一步可能移动的方向

---

### 4. 台风路径线（紫色轨迹）

**作用**: 显示台风完整移动轨迹

**数据来源**:
- 所有5个台风位置点（硬编码）
- 不依赖数据集

**显示方式**:
- 紫色连续线
- 每个位置点标注时间（00Z、06Z等）
- 白色圆点标记各时刻位置

---

### 5. 当前台风中心（红色X）

**作用**: 标识当前时刻的台风位置

**数据来源**:
- 当前台风点的经纬度

**显示方式**:
- 红色X标记
- 较大尺寸，便于识别

---

## 三、数据流总结图

```
图2（2022-01-01 06Z）数据流:

台风位置参数
│  ├─ 纬度: -21.78°
│  ├─ 经度: 157.46°
│  ├─ 数据类型: 输入
│  └─ 时间索引: 1
│
├─→ [梯度热力图]
│     ├─ 数据源: train_inputs['geopotential']
│     ├─ 时间: 索引1 (06Z输入状态)
│     ├─ 层次: 500 hPa
│     └─ 区域: 台风周围±15°
│
├─→ [等压线]
│     ├─ 数据源: train_inputs['mean_sea_level_pressure']
│     ├─ 时间: 索引1 (06Z)
│     └─ 单位: hPa
│
├─→ [引导气流箭头]
│     ├─ 数据源: train_inputs['u/v_component_of_wind']
│     ├─ 时间: 索引1 (06Z)
│     ├─ 气压层: 700 hPa
│     ├─ 空间: 环形区域 (2-5°)
│     └─ 方向: 顺风 (u, v)
│
├─→ [台风路径]
│     └─ 数据源: 硬编码（所有5个时刻）
│
└─→ [当前中心标记]
      └─ 位置: (-21.78°, 157.46°)
```

---

## 四、时间维度对应关系

### 完整时间映射表

| 台风时刻 | 真实时间 | 数据源 | 时间索引 | 梯度时间 | 物理场时间 |
|---------|---------|--------|---------|---------|-----------|
| 图1 | 01/01 00Z | 输入 | 0 | 0 (输入态) | 0 (00Z) |
| 图2 | 01/01 06Z | 输入 | 1 | 1 (输入态) | 1 (06Z) |
| 图3 | 01/01 12Z | 预测 | 0 | 0 (输入态) | 0 (12Z) |
| 图4 | 01/01 18Z | 预测 | 1 | 1 (输入态) | 1 (18Z) |
| 图5 | 01/02 00Z | 预测 | 2 | 无 | 2 (00Z) |

### 关键规则

**梯度数据**:
- 始终只有2个时间步（对应输入历史-6h和0h）
- 预测时刻（图3-5）使用输入时刻的梯度

**物理场数据（等压线、风场）**:
- 输入时刻 → 从`train_inputs`取数据
- 预测时刻 → 从`train_targets`取数据
- 时间索引与台风时刻对应

---

## 五、关键参数总结

### 优化后的最终参数

```
梯度计算:
  目标变量: geopotential（位势高度）
  目标层次: 500 hPa
  梯度类型: 负梯度（关注降低因素）

引导气流计算:
  气压层: 700 hPa（单层）
  内半径: 2.0°
  外半径: 5.0°
  方向: 顺风 (u, v)

可视化范围:
  区域半径: ±15°
  网格分辨率: 1.0°
```

### 参数优化历程

**气压层**: 5层平均 → 700 hPa单层
- 原因: 各层风向冲突，平均后误差增大
- 效果: 误差减半（29.5° → 14.9°）

**环形半径**: (3-7°) → (2-5°)
- 原因: 参数扫描实验优化结果
- 效果: 误差减小4.2°

**箭头方向**: 逆风 → 顺风
- 原因: 更直观表达台风移动趋势
- 效果: 可视化更易理解

---

## 六、常见问题

### Q1: 为什么预测时刻也用输入数据的梯度？

梯度计算的目的是分析**输入对预测的影响**，因此梯度始终来自输入历史（-6h和0h）。预测时刻的物理场是预测结果，但梯度仍反映输入的重要性。

### Q2: 为什么只用700 hPa而不是多层平均？

对于弱热带风暴，不同气压层的风向差异很大：
- 850 hPa受地表摩擦影响，方向错误
- 500-200 hPa属于高空急流，方向偏东
- 700 hPa位于对流层中部，最能代表引导气流

强台风才需要深层平均，弱热带风暴用单层更准确。

### Q3: 环形区域的意义是什么？

环形区域（annulus）是气象学标准方法：
- **内半径（2°）**: 排除台风自身环流的影响
- **外半径（5°）**: 捕获周围环境风场
- **环形平均**: 提取纯粹的环境引导气流

如果直接用台风中心点的风速，会被台风自己的环流污染。

---

## 参考资料

实验验证脚本:
- `test_steering_parameters.py` - 参数扫描实验（30种组合）
- `diagnose_layer_winds.py` - 分层诊断实验（各气压层误差分析）

气象学依据:
- Holland (1984): Tropical cyclone motion
- JTWC/CMA 台风引导气流计算标准

---

**文档版本**: v2.0（简化版）
**最后更新**: 2026-01-07
**对应代码**: 使用700 hPa单层 + 环形区域2-5°
