# 台风物理-AI对齐分析图 - 变量取值说明（简化版）

## 文档目标

说明每张台风分析图中各可视化元素的数据来源和取值逻辑。

---

## 一、数据集结构

### 原始数据时间范围
2022-01-01 00:00 → 2022-01-02 06:00（共6个时间点，每6小时一次）

### GraphCast 数据划分

```
================================================================================
训练数据时间信息
================================================================================

📅 数据集参考日期: 2022-01-01

🔹 train_inputs 包含的时间点:
   时间点数量: 2
   [0] 相对时间: +  -6.0h -> 绝对时间: 2021-12-31 18:00:00 UTC
   [1] 相对时间: +   0.0h -> 绝对时间: 2022-01-01 00:00:00 UTC

🔹 train_targets 包含的时间点:
   时间点数量: 1
   [0] 相对时间: +   6.0h -> 绝对时间: 2022-01-01 06:00:00 UTC

================================================================================
评估数据时间信息
================================================================================

🔹 eval_inputs 包含的时间点:
   时间点数量: 2
   [0] 相对时间: +  -6.0h -> 绝对时间: 2021-12-31 18:00:00 UTC
   [1] 相对时间: +   0.0h -> 绝对时间: 2022-01-01 00:00:00 UTC

🔹 eval_targets 包含的时间点:
   时间点数量: 4
   [0] 相对时间: +   6.0h -> 绝对时间: 2022-01-01 06:00:00 UTC
   [1] 相对时间: +  12.0h -> 绝对时间: 2022-01-01 12:00:00 UTC
   [2] 相对时间: +  18.0h -> 绝对时间: 2022-01-01 18:00:00 UTC
   [3] 相对时间: +  24.0h -> 绝对时间: 2022-01-02 00:00:00 UTC

💡 说明:
   - eval_inputs 固定包含2个连续时间点 (用于预测的输入)
   - eval_targets 包含多个预测目标时间点 (由 eval_steps 参数决定)
   - 时间间隔为6小时
================================================================================
```

### 台风位置数据（硬编码）

| 时间 | 纬度 | 经度 | 数据源 | 时间索引 |
|------|------|------|--------|---------|
| 01/01 00Z | -21.22° | 156.71° | 输入 | 0 |
| 01/01 06Z | -21.78° | 157.46° | 输入 | 1 |
| 01/01 12Z | -22.56° | 158.29° | 预测 | 0 |
| 01/01 18Z | -23.91° | 158.80° | 预测 | 1 |
| 01/02 00Z | -25.83° | 159.01° | 预测 | 2 |

---

## 二、单张图的变量取值逻辑

以**图2（2022-01-01 06Z）**为例：

```
台风位置: (-21.78°, 157.46°)
数据类型: 输入数据
时间索引: 1
```

### 1. 梯度热力图（AI的关注区域）

**作用**: 显示AI模型认为哪些区域对台风预测最重要

**数据来源**:
- 变量: `geopotential`（位势高度）
- 数据集: `train_inputs`（始终使用输入历史）
- 时间: 索引1（对应06Z的输入状态）
- 气压层: 500 hPa
- 空间: 全球网格 → 裁剪到台风周围±15°

**为什么这样选**:
- 梯度反映输入对预测的影响，所以始终来自输入数据
- 500 hPa代表中层大气，是台风强度的关键指标

---

### 2. 等压线（物理场背景）

**作用**: 显示海平面气压分布，标识台风的低压系统

**数据来源**:
- 变量: `mean_sea_level_pressure`（海平面气压）
- 数据集: `train_inputs`（因为是输入时刻）
- 时间: 索引1（对应06Z）
- 单位: hPa（已转换）

**为什么这样选**:
- 对于输入时刻（00Z, 06Z）→ 从`train_inputs`取数据
- 对于预测时刻（12Z, 18Z, 00Z+24h）→ 从`train_targets`取数据
- 海平面气压是识别台风位置的最直观物理量

---

### 3. 引导气流箭头（台风移动趋势）

**作用**: 显示环境风场推动台风移动的方向

**数据来源**:
- 变量: `u_component_of_wind`, `v_component_of_wind`
- 数据集: `train_inputs`（因为是输入时刻）
- 时间: 索引1（对应06Z）
- 气压层: **700 hPa**（单层）
- 空间平均: 环形区域（内半径2°，外半径5°）

**关键参数**:

| 参数 | 值 | 说明 |
|------|-----|------|
| 气压层 | 700 hPa | 对热带风暴最准确的引导层 |
| 内半径 | 2° | 排除台风自身环流影响 |
| 外半径 | 5° | 捕获环境引导气流 |
| 箭头方向 | 顺风 (u, v) | 指向台风移动趋势 |

---

### 4. 台风路径线（紫色轨迹）

**作用**: 显示台风完整移动轨迹

**数据来源**:
- 所有5个台风位置点（硬编码）
- 不依赖数据集

**显示方式**:
- 紫色连续线
- 每个位置点标注时间（00Z、06Z等）
- 白色圆点标记各时刻位置

---

### 5. 当前台风中心（红色X）

**作用**: 标识当前时刻的台风位置

**数据来源**:
- 当前台风点的经纬度

**显示方式**:
- 红色X标记
- 较大尺寸，便于识别

---

## 三、数据流总结图

```
图2（2022-01-01 06Z）数据流:

台风位置参数
│  ├─ 纬度: -21.78°
│  ├─ 经度: 157.46°
│  ├─ 数据类型: 输入
│  └─ 时间索引: 1
│
├─→ [梯度热力图]
│     ├─ 数据源: train_inputs['geopotential']
│     ├─ 时间: 索引1 (06Z输入状态)
│     ├─ 层次: 500 hPa
│     └─ 区域: 台风周围±15°
│
├─→ [等压线]
│     ├─ 数据源: train_inputs['mean_sea_level_pressure']
│     ├─ 时间: 索引1 (06Z)
│     └─ 单位: hPa
│
├─→ [引导气流箭头]
│     ├─ 数据源: train_inputs['u/v_component_of_wind']
│     ├─ 时间: 索引1 (06Z)
│     ├─ 气压层: 700 hPa
│     ├─ 空间: 环形区域 (2-5°)
│     └─ 方向: 顺风 (u, v)
│
├─→ [台风路径]
│     └─ 数据源: 硬编码（所有5个时刻）
│
└─→ [当前中心标记]
      └─ 位置: (-21.78°, 157.46°)
```

---

## 四、时间维度对应关系

### 完整时间映射表

| 台风时刻 | 真实时间 | 数据源 | 时间索引 | 梯度时间 | 物理场时间 |
|---------|---------|--------|---------|---------|-----------|
| 图1 | 01/01 00Z | 输入 | 0 | 0 (输入态) | 0 (00Z) |
| 图2 | 01/01 06Z | 输入 | 1 | 1 (输入态) | 1 (06Z) |
| 图3 | 01/01 12Z | 预测 | 0 | 0 (输入态) | 0 (12Z) |
| 图4 | 01/01 18Z | 预测 | 1 | 1 (输入态) | 1 (18Z) |
| 图5 | 01/02 00Z | 预测 | 2 | 无 | 2 (00Z) |

### 关键规则

**梯度数据**:
- 始终只有2个时间步（对应输入历史-6h和0h）
- 预测时刻（图3-5）使用输入时刻的梯度

**物理场数据（等压线、风场）**:
- 输入时刻 → 从`train_inputs`取数据
- 预测时刻 → 从`train_targets`取数据
- 时间索引与台风时刻对应
